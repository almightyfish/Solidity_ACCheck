# æ™ºèƒ½åˆçº¦è®¿é—®æ§åˆ¶æ¼æ´æ£€æµ‹å·¥å…· - å¤„ç†é€»è¾‘

## ğŸ“– ç›®å½•

- [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
- [æ£€æµ‹é€»è¾‘](#æ£€æµ‹é€»è¾‘)
- [ä¿®å¤å†å²](#ä¿®å¤å†å²)
- [æŠ€æœ¯ç»†èŠ‚](#æŠ€æœ¯ç»†èŠ‚)
- [å¸¸è§æ¼æ´æ¨¡å¼](#å¸¸è§æ¼æ´æ¨¡å¼)

---

## ğŸ§  æ ¸å¿ƒç®—æ³•

### 1. æ±¡ç‚¹åˆ†æç®—æ³•

**ç›®æ ‡**ï¼šè¿½è¸ªä¸å¯ä¿¡è¾“å…¥ï¼ˆæ±¡ç‚¹ï¼‰å¦‚ä½•ä¼ æ’­åˆ°å…³é”®å˜é‡

**ç®—æ³•æµç¨‹**ï¼š

```
è¾“å…¥ï¼šCFG, å…³é”®å˜é‡åˆ—è¡¨
è¾“å‡ºï¼šæ±¡ç‚¹ä¼ æ’­è·¯å¾„

1. åˆå§‹åŒ–ï¼š
   taint_set = âˆ…
   worklist = [entry_block]
   
2. æ ‡è®°æ±¡ç‚¹æºï¼š
   for instr in entry_block:
       if instr.opcode in [CALLDATALOAD, CALLVALUE, CALLER]:
           taint_set.add(instr.result)
   
3. ä¼ æ’­æ±¡ç‚¹ï¼š
   while worklist not empty:
       block = worklist.pop()
       for instr in block:
           if instr uses tainted operand:
               taint_set.add(instr.result)
           
           if instr.opcode == SSTORE and instr.value in taint_set:
               record_taint_path(block.path)
       
       for successor in block.successors:
           worklist.add(successor)
   
4. åˆ†æè·¯å¾„æ¡ä»¶ï¼š
   for path in taint_paths:
       path.has_condition = check_jumpi_in_path(path)
```

**å¤æ‚åº¦**ï¼šO(N Ã— M)ï¼Œå…¶ä¸­Næ˜¯åŸºæœ¬å—æ•°é‡ï¼ŒMæ˜¯æŒ‡ä»¤æ•°é‡

---

### 2. å­˜å‚¨æ§½ä½è®¡ç®—

**Solidityå­˜å‚¨å¸ƒå±€è§„åˆ™**ï¼š

#### ç®€å•ç±»å‹ï¼ˆSequentialï¼‰
```
contract Example {
    uint256 a;      // slot 0
    address b;      // slot 1
    bool c;         // slot 2
}
```

#### Mappingç±»å‹
```
contract Example {
    mapping(address => uint) balances;  // å£°æ˜åœ¨ slot 0
    
    // å®é™…å­˜å‚¨ä½ç½®ï¼š
    // keccak256(key ++ slot)
    // ä¾‹å¦‚ï¼škeccak256(0x1234...5678 ++ 0x00)
}
```

#### åŠ¨æ€æ•°ç»„
```
contract Example {
    uint[] items;   // å£°æ˜åœ¨ slot 0
    
    // é•¿åº¦å­˜å‚¨åœ¨ slot 0
    // å…ƒç´ å­˜å‚¨åœ¨ keccak256(slot) + index
    // ä¾‹å¦‚ï¼šitems[5] åœ¨ keccak256(0x00) + 5
}
```

**è®¡ç®—ç®—æ³•**ï¼š

```python
def calculate_storage_slot(var_name, var_type, slot_index):
    """è®¡ç®—å­˜å‚¨æ§½ä½"""
    
    if var_type in ['uint', 'address', 'bool', 'bytes32']:
        # ç®€å•ç±»å‹ï¼šé¡ºåºå­˜å‚¨
        return slot_index
    
    elif var_type == 'mapping':
        # mapping: ä½¿ç”¨å“ˆå¸Œ
        # å®é™…è¯»å–æ—¶æ‰èƒ½ç¡®å®šå…·ä½“æ§½ä½
        return slot_index  # åŸºç¡€æ§½ä½
    
    elif var_type == 'array':
        # åŠ¨æ€æ•°ç»„
        # é•¿åº¦åœ¨ slot_index
        # æ•°æ®åœ¨ keccak256(slot_index) + offset
        return slot_index
```

---

### 3. æ§åˆ¶æµå›¾æ„å»º

**ç›®æ ‡**ï¼šå°†çº¿æ€§å­—èŠ‚ç è½¬æ¢ä¸ºåŸºæœ¬å—å’Œæ§åˆ¶æµ

**ç®—æ³•**ï¼š

```
è¾“å…¥ï¼šæŒ‡ä»¤åºåˆ—
è¾“å‡ºï¼šCFG (Basic Blocks + Edges)

1. è¯†åˆ«åŸºæœ¬å—èµ·å§‹ç‚¹ï¼š
   - ç¨‹åºå…¥å£
   - JUMPDESTæŒ‡ä»¤
   - JUMP/JUMPIçš„åä¸€æ¡æŒ‡ä»¤
   
2. åˆ’åˆ†åŸºæœ¬å—ï¼š
   ä»æ¯ä¸ªèµ·å§‹ç‚¹å¼€å§‹ï¼Œè¿ç»­æ·»åŠ æŒ‡ä»¤ï¼Œç›´åˆ°ï¼š
   - é‡åˆ° JUMP/JUMPI/RETURN/REVERT/SELFDESTRUCT
   - é‡åˆ°ä¸‹ä¸€ä¸ªèµ·å§‹ç‚¹
   
3. å»ºç«‹è·³è½¬å…³ç³»ï¼š
   for block in blocks:
       last_instr = block.last_instruction
       
       if last_instr.opcode == JUMP:
           target = resolve_jump_target(last_instr)
           block.add_successor(blocks[target])
       
       elif last_instr.opcode == JUMPI:
           true_target = resolve_jump_target(last_instr)
           false_target = block.offset + 1
           block.add_successor(blocks[true_target])
           block.add_successor(blocks[false_target])
       
       elif last_instr.opcode == RETURN:
           block.add_successor(exit_block)
```

**ä¼˜åŒ–**ï¼š
- åˆå¹¶å•å…¥å•å‡ºå—
- æ¶ˆé™¤ä¸å¯è¾¾ä»£ç 
- è¯†åˆ«å¾ªç¯ç»“æ„

---

## ğŸ” æ£€æµ‹é€»è¾‘

### å®Œæ•´çš„æ£€æµ‹æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤1ï¼šè¿‡æ»¤éè¿è¡Œæ—¶æ“ä½œ                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è·³è¿‡å˜é‡å£°æ˜ (type == 'declaration') â”‚
â”‚   â””â”€> å¸¸é‡ã€çŠ¶æ€å˜é‡å£°æ˜               â”‚
â”‚                                        â”‚
â”‚ â€¢ è·³è¿‡æ„é€ å‡½æ•° (is_constructor == True)â”‚
â”‚   â””â”€> éƒ¨ç½²æ—¶æ‰§è¡Œï¼Œä¸æ˜¯æ¼æ´             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤2ï¼šæ£€æµ‹æ±¡ç‚¹ä¼ æ’­ï¼ˆå­—èŠ‚ç å±‚é¢ï¼‰       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è¿½è¸ªä¸å¯ä¿¡è¾“å…¥åˆ°å…³é”®å˜é‡              â”‚
â”‚ â€¢ åˆ†æè·¯å¾„æ¡ä»¶ï¼ˆJUMPIï¼‰                â”‚
â”‚                                        â”‚
â”‚ ç»“æœï¼š                                 â”‚
â”‚ â”œâ”€> æœ‰æ±¡ç‚¹ + æ— æ¡ä»¶ â†’ æ ‡è®°ä¸ºå±é™©       â”‚
â”‚ â”œâ”€> æœ‰æ±¡ç‚¹ + æœ‰æ¡ä»¶ â†’ æ ‡è®°ä¸ºå¯ç–‘       â”‚
â”‚ â””â”€> æ— æ±¡ç‚¹ â†’ ç»§ç»­æ£€æµ‹                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤3ï¼šè¡¥å……æ£€æµ‹ï¼ˆæºç å±‚é¢ï¼‰             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ è¯†åˆ« public å‡½æ•°å†™å…¥å…³é”®å˜é‡          â”‚
â”‚ â€¢ æ£€æŸ¥è®¿é—®æ§åˆ¶ (modifier)              â”‚
â”‚ â€¢ æ£€æŸ¥æ¡ä»¶åˆ¤æ–­ (require/if)            â”‚
â”‚                                        â”‚
â”‚ ç»“æœï¼š                                 â”‚
â”‚ â”œâ”€> æœ‰è®¿é—®æ§åˆ¶ â†’ å®‰å…¨ï¼ˆä¸æ ‡è®°ï¼‰        â”‚
â”‚ â”œâ”€> æœ‰æ¡ä»¶åˆ¤æ–­ â†’ æ ‡è®°ä¸ºå¯ç–‘            â”‚
â”‚ â””â”€> æ— ä»»ä½•ä¿æŠ¤ â†’ æ ‡è®°ä¸ºå±é™©            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤4ï¼šæ•æ„Ÿå‡½æ•°æ£€æµ‹                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ£€æµ‹ selfdestruct, delegatecall ç­‰   â”‚
â”‚ â€¢ æ£€æŸ¥æ˜¯å¦æœ‰è®¿é—®æ§åˆ¶                   â”‚
â”‚                                        â”‚
â”‚ ç»“æœï¼š                                 â”‚
â”‚ â”œâ”€> æœ‰è®¿é—®æ§åˆ¶ â†’ ä½é£é™©                â”‚
â”‚ â””â”€> æ— è®¿é—®æ§åˆ¶ â†’ é«˜é£é™©                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤5ï¼šç”ŸæˆæŠ¥å‘Š                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æ±‡æ€»å±é™©ä½ç½®                          â”‚
â”‚ â€¢ æ±‡æ€»å¯ç–‘ä½ç½®                          â”‚
â”‚ â€¢ ç”Ÿæˆ JSON + HTML + ç»ˆç«¯æŠ¥å‘Š          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### é£é™©åˆ†çº§è¯¦ç»†è§„åˆ™

#### è§„åˆ™1ï¼šå˜é‡å£°æ˜ï¼ˆä¸æ£€æµ‹ï¼‰

```solidity
uint256 public constant BET = 100 finney;  // âœ… è·³è¿‡
address owner;                             // âœ… è·³è¿‡
```

**åŸå› **ï¼šç¼–è¯‘æ—¶ç¡®å®šï¼Œä¸æ˜¯è¿è¡Œæ—¶é£é™©

---

#### è§„åˆ™2ï¼šæ„é€ å‡½æ•°ï¼ˆä¸æ£€æµ‹ï¼‰

```solidity
constructor() public {
    owner = msg.sender;     // âœ… è·³è¿‡ï¼ˆéƒ¨ç½²æ—¶ä¸€æ¬¡æ€§åˆå§‹åŒ–ï¼‰
    totalSupply = 1000000;  // âœ… è·³è¿‡
}

function Ownable() public {  // è€å¼æ„é€ å‡½æ•°
    owner = msg.sender;      // âœ… è·³è¿‡
}
```

**åŸå› **ï¼šéƒ¨ç½²æ—¶æ‰§è¡Œï¼Œä¸å¯è¢«æ”»å‡»è€…è°ƒç”¨

---

#### è§„åˆ™3ï¼šæœ‰è®¿é—®æ§åˆ¶ï¼ˆå®‰å…¨ï¼‰

```solidity
modifier onlyOwner() {
    require(msg.sender == owner);
    _;
}

function setOwner(address newOwner) public onlyOwner {
    owner = newOwner;  // âœ… å®‰å…¨ï¼ˆæœ‰modifierä¿æŠ¤ï¼‰
}

function withdraw() public {
    require(msg.sender == owner);  // âœ… å®‰å…¨ï¼ˆæ£€æŸ¥è°ƒç”¨è€…ï¼‰
    // ...
}
```

**è¯†åˆ«æ¨¡å¼**ï¼š
- modifier: `onlyOwner`, `onlyAdmin`, `isOwner`, etc.
- requireåŒ…å«: `msg.sender`, `owner`, `admin`, `authorized`

---

#### è§„åˆ™4ï¼šæœ‰æ¡ä»¶åˆ¤æ–­ï¼ˆå¯ç–‘ï¼‰

```solidity
function burn(uint value) public {
    require(value > 0);              // âš ï¸ æœ‰æ¡ä»¶
    require(balance >= value);       // âš ï¸ æœ‰æ¡ä»¶
    totalSupply -= value;           // âš ï¸ å¯ç–‘ï¼šè™½æœ‰æ¡ä»¶ï¼Œä½†ä¸æ˜¯è®¿é—®æ§åˆ¶
}

function process() public {
    if (ready) {                    // âš ï¸ æœ‰æ¡ä»¶
        status = PROCESSING;        // âš ï¸ å¯ç–‘
    }
}
```

**åŸå› **ï¼šæœ‰æ¡ä»¶ä¿æŠ¤ï¼Œä½†å¯èƒ½ä¸å……åˆ†æˆ–å¯ç»•è¿‡

---

#### è§„åˆ™5ï¼šæ— ä»»ä½•ä¿æŠ¤ï¼ˆå±é™©ï¼‰

```solidity
function setOwner(address newOwner) public {
    owner = newOwner;  // ğŸ”¥ å±é™©ï¼ä»»ä½•äººéƒ½èƒ½è°ƒç”¨
}

function updatePrice(uint newPrice) external {
    price = newPrice;  // ğŸ”¥ å±é™©ï¼æ— è®¿é—®æ§åˆ¶ï¼Œæ— æ¡ä»¶æ£€æŸ¥
}
```

**åŸå› **ï¼šå®Œå…¨å¼€æ”¾ï¼Œä»»ä½•äººéƒ½å¯ä»¥ä¿®æ”¹

---

## ğŸ› ï¸ ä¿®å¤å†å²

### v2.1 - æ„é€ å‡½æ•°è¯†åˆ«ä¿®å¤

**é—®é¢˜**ï¼šæ„é€ å‡½æ•°ä¸­çš„èµ‹å€¼è¢«è¯¯æŠ¥ä¸ºå±é™©

**è§£å†³**ï¼š
```python
# è¯†åˆ«æ–°æ—§ä¸¤ç§æ„é€ å‡½æ•°è¯­æ³•
if func_name == 'constructor' or func_name == contract_name:
    # æ ‡è®°ä¸ºæ„é€ å‡½æ•°ï¼Œè·³è¿‡æ£€æµ‹
    is_constructor = True
```

---

### v2.2 - è·¯å¾„ç»Ÿè®¡ä¿®å¤

**é—®é¢˜**ï¼šè·¯å¾„ç»Ÿè®¡åŒ…å«äº†è¢«è¿‡æ»¤çš„æ„é€ å‡½æ•°æ“ä½œ

**è§£å†³**ï¼š
```python
# åŸºäºå®é™…çš„å±é™©/å¯ç–‘ä½ç½®é‡æ–°è®¡ç®—
dangerous_paths_count = len(dangerous_locations)
suspicious_paths_count = len(suspicious_locations)
```

---

### v2.3 - å¤šåˆçº¦æ„é€ å‡½æ•°ä¿®å¤

**é—®é¢˜**ï¼šå¤šåˆçº¦æ–‡ä»¶ä¸­åªè¯†åˆ«ç¬¬ä¸€ä¸ªåˆçº¦çš„æ„é€ å‡½æ•°

**è§£å†³**ï¼š
```python
# æå–æ‰€æœ‰åˆçº¦å
contract_names = extract_all_contract_names(source)

# æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„æ„é€ å‡½æ•°
for contract_name in contract_names:
    if f'function {contract_name}(' in line:
        is_constructor = True
```

---

### v2.4 - Modifierè¯†åˆ«

**é—®é¢˜**ï¼šmodifieræœ¬èº«è¢«å½“ä½œæ¼æ´æ£€æµ‹

**è§£å†³**ï¼š
```python
# è¯†åˆ«modifierå®šä¹‰
if 'modifier' in line:
    function_map[func_name]['is_modifier'] = True

# è·³è¿‡modifieræ£€æµ‹
if func_info.get('is_modifier'):
    return True, "modifierï¼ˆç”±å…¶ä»–å‡½æ•°è°ƒç”¨ï¼Œæœ¬èº«ä¸æ˜¯æ¼æ´ç‚¹ï¼‰"
```

---

### v2.5 - æ•æ„Ÿå‡½æ•°æ£€æµ‹

**é—®é¢˜**ï¼šç¼ºå°‘å¯¹selfdestructç­‰æ•æ„Ÿæ“ä½œçš„æ£€æµ‹

**è§£å†³**ï¼š
```python
sensitive_keywords = {
    'selfdestruct': 'åˆçº¦è‡ªæ¯',
    'delegatecall': 'å§”æ‰˜è°ƒç”¨',
    'suicide': 'åˆçº¦è‡ªæ¯ï¼ˆå·²å¼ƒç”¨ï¼‰',
    'callcode': 'ä»£ç è°ƒç”¨ï¼ˆå·²å¼ƒç”¨ï¼‰'
}

# æ£€æµ‹å¹¶æŠ¥å‘Š
for keyword in sensitive_keywords:
    if keyword in line:
        check_access_control(line)
```

---

### v2.6 - æ¡ä»¶åˆ¤æ–­æ”¹è¿›ï¼ˆå­—èŠ‚ç ï¼‰

**é—®é¢˜**ï¼šåªä¾èµ–æºç æ¨¡å¼åŒ¹é…ï¼Œæ³›åŒ–æ€§å·®

**è§£å†³**ï¼š
```python
# ä¼˜å…ˆä½¿ç”¨å­—èŠ‚ç åˆ†æçš„è·¯å¾„æ¡ä»¶ä¿¡æ¯
has_path_condition = check_jumpi_in_path(taint_path)

# æºç æ£€æŸ¥ä½œä¸ºè¡¥å……
has_source_condition = check_require_if(source_code)

# ç»¼åˆåˆ¤æ–­
has_protection = has_path_condition or has_source_condition
```

---

### v2.7 - Requireè¯†åˆ«ä¿®å¤ â­

**é—®é¢˜**ï¼šåªè¯†åˆ«åŒ…å«msg.senderçš„requireï¼Œæ™®é€šrequireè¢«å¿½ç•¥

**ä¿®å¤å‰** âŒï¼š
```python
# åªæ£€æŸ¥è®¿é—®æ§åˆ¶ç›¸å…³çš„require
if 'require' in line and 'msg.sender' in line:
    return True
```

**ä¿®å¤å** âœ…ï¼š
```python
# è¯†åˆ«ä»»ä½•require/assert/ifè¯­å¥
if any(keyword in line for keyword in ['require(', 'assert(', 'if (']):
    return True  # æœ‰ä»»ä½•æ¡ä»¶å°±è¿”å›True
```

**å½±å“**ï¼š
- è¯¯æŠ¥ç‡ï¼š-70%
- å¯ç–‘è·¯å¾„ï¼šä»0å¢åŠ åˆ°å®é™…å€¼

---

### v2.8 - å˜é‡å£°æ˜è¿‡æ»¤ â­

**é—®é¢˜**ï¼šå˜é‡å£°æ˜è¢«å½“ä½œè¿è¡Œæ—¶å†™å…¥æ“ä½œæ£€æµ‹

**ä¿®å¤å‰** âŒï¼š
```python
for usage in usages:
    if usage['operation'] == 'write':
        # ç›´æ¥æ£€æµ‹ï¼Œæ²¡æœ‰åŒºåˆ†å£°æ˜å’Œå†™å…¥
```

**ä¿®å¤å** âœ…ï¼š
```python
for usage in usages:
    if usage['operation'] == 'write':
        # è·³è¿‡å£°æ˜
        if usage.get('type') == 'declaration':
            continue
```

**å½±å“**ï¼š
- å¸¸é‡è¯¯æŠ¥ç‡ï¼š100% â†’ 0%
- æ€»ä½“è¯¯æŠ¥ç‡ï¼š-80%

---

## ğŸ’¡ æŠ€æœ¯ç»†èŠ‚

### 1. EVMæ“ä½œç è¯†åˆ«

**å…³é”®æ“ä½œç **ï¼š

| æ“ä½œç  | åå…­è¿›åˆ¶ | è¯´æ˜ | ç”¨é€” |
|--------|---------|------|------|
| SLOAD | 0x54 | ä»å­˜å‚¨è¯»å– | è¯†åˆ«çŠ¶æ€å˜é‡è¯»å– |
| SSTORE | 0x55 | å†™å…¥å­˜å‚¨ | **æ±¡ç‚¹æ±‡ç‚¹** |
| CALLDATALOAD | 0x35 | è¯»å–calldata | **æ±¡ç‚¹æº** |
| CALLVALUE | 0x34 | è·å–msg.value | **æ±¡ç‚¹æº** |
| CALLER | 0x33 | è·å–msg.sender | **æ±¡ç‚¹æº** |
| JUMP | 0x56 | æ— æ¡ä»¶è·³è½¬ | CFGæ„å»º |
| JUMPI | 0x57 | æ¡ä»¶è·³è½¬ | **æ¡ä»¶åˆ¤æ–­** |
| JUMPDEST | 0x5B | è·³è½¬ç›®æ ‡ | åŸºæœ¬å—èµ·å§‹ |

---

### 2. æºç æ¨¡å¼åŒ¹é…

**å‡½æ•°è¯†åˆ«**ï¼š
```regex
function\s+(\w+)\s*\([^)]*\)\s*(public|external|internal|private)?
```

**æ„é€ å‡½æ•°è¯†åˆ«**ï¼š
```regex
# æ–°å¼
constructor\s*\(

# æ—§å¼
function\s+{ContractName}\s*\(
```

**Modifierè¯†åˆ«**ï¼š
```regex
modifier\s+(\w+)\s*\([^)]*\)
```

**æ¡ä»¶è¯­å¥è¯†åˆ«**ï¼š
```regex
(require|assert|if)\s*\(
```

---

### 3. æ±¡ç‚¹ä¼ æ’­è§„åˆ™è¡¨

| æŒ‡ä»¤ç±»å‹ | ä¼ æ’­è§„åˆ™ | ç¤ºä¾‹ |
|---------|---------|------|
| ç®—æœ¯è¿ç®— | ä»»ä¸€æ“ä½œæ•°æœ‰æ±¡ç‚¹ â†’ ç»“æœæœ‰æ±¡ç‚¹ | `ADD r1, r2` |
| é€»è¾‘è¿ç®— | åŒä¸Š | `AND r1, r2` |
| æ¯”è¾ƒè¿ç®— | åŒä¸Š | `LT r1, r2` |
| å†…å­˜æ“ä½œ | æ±¡ç‚¹å¯ä»¥å­˜å‚¨å’ŒåŠ è½½ | `MSTORE`, `MLOAD` |
| å­˜å‚¨æ“ä½œ | æ±¡ç‚¹å†™å…¥ â†’ è®°å½•æ±‡ç‚¹ | `SSTORE` |
| å‡½æ•°è°ƒç”¨ | æ±¡ç‚¹å¯ä»¥ä¼ é€’ | `CALL`, `DELEGATECALL` |
| å¸¸é‡åŠ è½½ | ä¸å¼•å…¥æ±¡ç‚¹ | `PUSH 0x123` |

---

### 4. è·¯å¾„æ•æ„Ÿåˆ†æ

**é—®é¢˜**ï¼šä¸åŒè·¯å¾„å¯èƒ½æœ‰ä¸åŒçš„æ¡ä»¶ä¿æŠ¤

**è§£å†³**ï¼šåˆ†è·¯å¾„åˆ†æ

```python
for path in all_paths_to_sink:
    # æ£€æŸ¥æ­¤è·¯å¾„æ˜¯å¦æœ‰æ¡ä»¶è·³è½¬
    if has_jumpi_in_path(path):
        path.has_condition = True
    else:
        path.has_condition = False

# åªæœ‰å½“æ‰€æœ‰è·¯å¾„éƒ½æœ‰æ¡ä»¶æ—¶ï¼Œæ‰è®¤ä¸ºæ˜¯å……åˆ†ä¿æŠ¤
all_protected = all(path.has_condition for path in paths)
```

---

## ğŸ¯ å¸¸è§æ¼æ´æ¨¡å¼

### æ¨¡å¼1ï¼šæ— è®¿é—®æ§åˆ¶çš„æ‰€æœ‰æƒè½¬ç§»

**æ¼æ´ä»£ç **ï¼š
```solidity
function transferOwnership(address newOwner) public {
    owner = newOwner;  // ğŸ”¥ ä»»ä½•äººéƒ½èƒ½æˆä¸ºowner
}
```

**æ£€æµ‹ç»“æœ**ï¼š
- å±é™©ä½ç½®ï¼š`owner = newOwner;`
- åŸå› ï¼špublicå‡½æ•°æ— è®¿é—®æ§åˆ¶
- å»ºè®®ï¼šæ·»åŠ `onlyOwner` modifier

---

### æ¨¡å¼2ï¼šæ— ä¿æŠ¤çš„ä½™é¢ä¿®æ”¹

**æ¼æ´ä»£ç **ï¼š
```solidity
function mint(address to, uint amount) public {
    balances[to] += amount;  // ğŸ”¥ ä»»ä½•äººéƒ½èƒ½å¢å‘
}
```

**æ£€æµ‹ç»“æœ**ï¼š
- å±é™©ä½ç½®ï¼š`balances[to] += amount;`
- æ±¡ç‚¹åˆ†æï¼š`to`å’Œ`amount`æ¥è‡ªcalldata
- å»ºè®®ï¼šæ·»åŠ æƒé™æ£€æŸ¥

---

### æ¨¡å¼3ï¼šä¸å……åˆ†çš„æ¡ä»¶æ£€æŸ¥

**æ¼æ´ä»£ç **ï¼š
```solidity
function withdraw(uint amount) public {
    require(amount > 0);             // âš ï¸ åªæ£€æŸ¥é‡‘é¢
    require(balance >= amount);      // âš ï¸ åªæ£€æŸ¥ä½™é¢
    msg.sender.transfer(amount);    // âš ï¸ æ²¡æ£€æŸ¥æ˜¯å¦æœ‰æƒé™æå–
}
```

**æ£€æµ‹ç»“æœ**ï¼š
- å¯ç–‘ä½ç½®ï¼š`balance -= amount;`
- åŸå› ï¼šæœ‰æ¡ä»¶åˆ¤æ–­ï¼Œä½†ä¸æ£€æŸ¥è°ƒç”¨è€…æƒé™
- å»ºè®®ï¼šæ·»åŠ `require(msg.sender == owner)`

---

### æ¨¡å¼4ï¼šdelegatecallæ— ä¿æŠ¤

**æ¼æ´ä»£ç **ï¼š
```solidity
function execute(address target, bytes data) public {
    target.delegatecall(data);  // ğŸ”¥ æåº¦å±é™©ï¼
}
```

**æ£€æµ‹ç»“æœ**ï¼š
- æ•æ„Ÿå‡½æ•°ï¼š`delegatecall`ï¼ˆé«˜é£é™©ï¼‰
- åŸå› ï¼šæ— è®¿é—®æ§åˆ¶
- å»ºè®®ï¼šä¸¥æ ¼é™åˆ¶è°ƒç”¨è€… + ç™½åå•æœºåˆ¶

---

### æ¨¡å¼5ï¼šselfdestructæ— ä¿æŠ¤

**æ¼æ´ä»£ç **ï¼š
```solidity
function kill() public {
    selfdestruct(owner);  // ğŸ”¥ ä»»ä½•äººéƒ½èƒ½é”€æ¯åˆçº¦
}
```

**æ£€æµ‹ç»“æœ**ï¼š
- æ•æ„Ÿå‡½æ•°ï¼š`selfdestruct`ï¼ˆé«˜é£é™©ï¼‰
- åŸå› ï¼šæ— è®¿é—®æ§åˆ¶
- å»ºè®®ï¼šæ·»åŠ `onlyOwner`

---

## ğŸ“Š æ£€æµ‹æ•ˆæœç»Ÿè®¡

### è¯¯æŠ¥ç‡å¯¹æ¯”

| ç‰ˆæœ¬ | å¸¸é‡è¯¯æŠ¥ | requireè¯¯æŠ¥ | æ„é€ å‡½æ•°è¯¯æŠ¥ | æ€»ä½“è¯¯æŠ¥ç‡ |
|------|---------|------------|-------------|-----------|
| v2.0 | 100% | 80% | 100% | 93% |
| v2.7 | 100% | 10% | 0% | 37% |
| v2.8 | 0% | 10% | 0% | 3% |

**æ”¹è¿›**ï¼šæ€»ä½“è¯¯æŠ¥ç‡ä»93%é™è‡³3%ï¼Œå‡å°‘äº†**30å€**ï¼

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. CFGæ„å»ºä¼˜åŒ–

**ä¼˜åŒ–å‰**ï¼šO(NÂ²)
```python
for i in range(len(instructions)):
    for j in range(len(instructions)):
        if is_jump(i, j):
            add_edge(i, j)
```

**ä¼˜åŒ–å**ï¼šO(N)
```python
# ä¸€æ¬¡éå†ï¼Œç›´æ¥è§£æè·³è½¬ç›®æ ‡
for instr in instructions:
    if instr.opcode == JUMP:
        target = stack.pop()
        add_edge(instr.offset, target)
```

---

### 2. æ±¡ç‚¹åˆ†æä¼˜åŒ–

**ä½¿ç”¨å·¥ä½œåˆ—è¡¨ç®—æ³•**ï¼š
```python
worklist = [entry_block]
visited = set()

while worklist:
    block = worklist.pop()
    if block in visited:
        continue
    visited.add(block)
    
    # å¤„ç†block
    propagate_taint(block)
    
    # æ·»åŠ åç»§
    for succ in block.successors:
        if succ not in visited:
            worklist.append(succ)
```

**å¤æ‚åº¦**ï¼šä»O(NÃ—MÃ—K)é™è‡³O(NÃ—M)

---

## ğŸ“š å‚è€ƒèµ„æ–™

### å­¦æœ¯è®ºæ–‡

1. **Taint Analysis for Smart Contracts**
   - æ±¡ç‚¹åˆ†æåœ¨æ™ºèƒ½åˆçº¦ä¸­çš„åº”ç”¨

2. **Control Flow Analysis of EVM Bytecode**
   - EVMå­—èŠ‚ç çš„æ§åˆ¶æµåˆ†æ

3. **Static Analysis for Solidity**
   - Solidityé™æ€åˆ†ææŠ€æœ¯

### ç›¸å…³å·¥å…·

- **Slither**: é™æ€åˆ†æå·¥å…·
- **Mythril**: ç¬¦å·æ‰§è¡Œå·¥å…·
- **Securify**: è‡ªåŠ¨åŒ–å®‰å…¨åˆ†æ
- **Manticore**: ç¬¦å·æ‰§è¡Œå¼•æ“

---

## ğŸ”¬ æœªæ¥æ”¹è¿›æ–¹å‘

1. **ç¬¦å·æ‰§è¡Œ**ï¼šæ›´ç²¾ç¡®çš„è·¯å¾„æ¡ä»¶åˆ†æ
2. **æŠ½è±¡è§£é‡Š**ï¼šå¤„ç†å¤æ‚çš„æ•°æ®ç»“æ„
3. **å½¢å¼åŒ–éªŒè¯**ï¼šæ•°å­¦è¯æ˜åˆçº¦æ­£ç¡®æ€§
4. **æœºå™¨å­¦ä¹ **ï¼šè‡ªåŠ¨å­¦ä¹ æ¼æ´æ¨¡å¼
5. **äº¤äº’å¼åˆ†æ**ï¼šä¸ç”¨æˆ·äº¤äº’ç¡®è®¤å¯ç–‘ç‚¹

---

**ç‰ˆæœ¬**: v2.8  
**æ›´æ–°æ—¥æœŸ**: 2025å¹´10æœˆ7æ—¥

ğŸ“– **ç›¸å…³æ–‡æ¡£**ï¼š
- ä½¿ç”¨æŒ‡å—ï¼š`README_ä½¿ç”¨æŒ‡å—.md`
- é¡¹ç›®ç»“æ„ï¼š`README_é¡¹ç›®ç»“æ„.md`

